name: Publish

on:
  branches:
    - 'main'
    - '^(releases\/)?[0-9]+\.[0-9]+\.x$'
  tags:
    - 'v[0-9]+.[0-9]+.[0-9]+(-.*)?'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: ci

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Version check
        id: bump
        uses: vkkotha/github-tag-action@1.37.0-beta.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: true
          RELEASE_BRANCHES: main,^(releases\/)?[0-9]+\.[0-9]+\.x$
          DRY_RUN: true
          TAG_CONTEXT: branch
          BUMP_STRATEGY: skip
          DEFAULT_BUMP: none
          VERBOSE: true
      - name: Print Version Info
        run: |
          echo "New Tag: ${{ steps.bump.outputs.new_tag }}"
          echo "Previous tag: ${{ steps.bump.outputs.tag }}"
          echo "Bump Type: ${{ steps.bump.outputs.part }}"

#      - uses: gradle/wrapper-validation-action@v1
#      - name: set up JDK 8
#        uses: actions/setup-java@v2
#        with:
#          java-version: '8'
#          distribution: 'adopt'
#          cache: gradle
#      - name: Grant execute permission for gradlew
#        run: chmod +x gradlew
#      - name: Build with Gradle
#        run: ./gradlew build
#      - name: Publish Unit Test Results
#        uses: EnricoMi/publish-unit-test-result-action@v1
#        if: always()
#        with:
#          files: build/test-results/**/*.xml
#      - name: Publish Maven Artifacts
#        run: ./gradlew publish
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#      - name: Upload binaries to release
#        uses: svenstaro/upload-release-action@v2
#        with:
#          repo_token: ${{ secrets.GITHUB_TOKEN }}
#          file: build/libs/*.jar
#          tag: ${{ github.ref }}
#          overwrite: true
#          file_glob: true
#      - name: Cleanup Gradle Cache
#        run: |
#          rm -f ~/.gradle/caches/modules-2/modules-2.lock
#          rm -f ~/.gradle/caches/modules-2/gc.properties
